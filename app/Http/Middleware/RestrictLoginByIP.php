<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class RestrictLoginByIP
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        $forwarded_ip = $request->header('X-Forwarded-For');
        $real_ip = $forwarded_ip ? explode(',', $forwarded_ip)[0] : $request->ip();

        $allowed_ips = ['213.230.99.98',
                        '127.0.0.1',
                        '188.113.207.220',
                        '192.168.40.10',
                        '192.168.40.11',
                        '192.168.40.12',
                        '192.168.40.13',
                        '192.168.40.14',
                        '192.168.40.15',
                        '192.168.40.16',
                        '192.168.40.17',
                        '192.168.40.18',
                        '192.168.40.19',
                        '192.168.40.20',
                        '192.168.40.21',
                        '192.168.40.22',
                        '192.168.40.23',
                        '192.168.40.24',
                        '192.168.40.25',
                        '192.168.40.26',
                        '192.168.40.27',
                        '192.168.40.28',
                        '192.168.40.29',
                        '192.168.40.30',
                        '192.168.40.31',
                        '192.168.40.32',
                        '192.168.40.33',
                        '192.168.40.34',
                        '192.168.40.35',
                        '192.168.40.36',
                        '192.168.40.37',
                        '192.168.40.38',
                        '192.168.40.39',
                        '192.168.40.40',
                        '192.168.40.41',
                        '192.168.40.42',
                        '192.168.40.43',
                        '192.168.40.44',
                        '192.168.40.45',
                        '192.168.40.46',
                        '192.168.40.47',
                        '192.168.40.48',
                        '192.168.40.49',
                        '192.168.40.50',
                        '192.168.40.51',
                        '192.168.40.52',
                        '192.168.40.53',
                        '192.168.40.54',
                        '192.168.40.55',
                        '192.168.40.56',
                        '192.168.40.57',
                        '192.168.40.58',
                        '192.168.40.59',
                        '192.168.40.60',
                        '192.168.40.61',
                        '192.168.40.62',
                        '192.168.40.63',
                        '192.168.40.64',
                        '192.168.40.65',
                        '192.168.40.66',
                        '192.168.40.67',
                        '192.168.40.68',
                        '192.168.40.69',
        ]; // sizga kerakli IPlar

        if (!in_array($real_ip, $allowed_ips)) {
            abort(403, 'Sizning IP manzilingiz (' . $real_ip . ') orqali kirish taqiqlangan.');
        }

        return $next($request);
    }

}
